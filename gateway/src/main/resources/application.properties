server.port=8888

# =============================================================================
# Gateway Routes Configuration
# =============================================================================
# Each route strips the service prefix and adds /api prefix:
#   /profile        -> /api           (to profile-service)
#   /profile/foo    -> /api/foo       (to profile-service)
#   /orders         -> /api           (to order-service)
#   /admin/users    -> /api/users     (to admin-service)
# Public endpoints follow the pattern: /{service}/public/**
#   /profile/public/register -> /api/public/register (to profile-service)

# Profile Service Routes
spring.cloud.gateway.server.webflux.routes[0].id=profile-service
spring.cloud.gateway.server.webflux.routes[0].uri=${PROFILE_SERVICE_URL:http://127.0.0.1:8082}
spring.cloud.gateway.server.webflux.routes[0].predicates[0]=Path=/profile/**
spring.cloud.gateway.server.webflux.routes[0].filters[0]=StripPrefix=1
spring.cloud.gateway.server.webflux.routes[0].filters[1]=PrefixPath=/api
spring.cloud.gateway.server.webflux.routes[0].filters[2].name=RequestRateLimiter
spring.cloud.gateway.server.webflux.routes[0].filters[2].args.redis-rate-limiter.replenishRate=10
spring.cloud.gateway.server.webflux.routes[0].filters[2].args.redis-rate-limiter.burstCapacity=20
spring.cloud.gateway.server.webflux.routes[0].filters[2].args.key-resolver=#{@userKeyResolver}
spring.cloud.gateway.server.webflux.routes[0].filters[3].name=CircuitBreaker
spring.cloud.gateway.server.webflux.routes[0].filters[3].args.name=profileServiceCB
spring.cloud.gateway.server.webflux.routes[0].filters[3].args.fallbackUri=forward:/fallback

# Order Service Routes
spring.cloud.gateway.server.webflux.routes[1].id=order-service
spring.cloud.gateway.server.webflux.routes[1].uri=${ORDER_SERVICE_URL:http://127.0.0.1:8083}
spring.cloud.gateway.server.webflux.routes[1].predicates[0]=Path=/orders/**
spring.cloud.gateway.server.webflux.routes[1].filters[0]=StripPrefix=1
spring.cloud.gateway.server.webflux.routes[1].filters[1]=PrefixPath=/api
spring.cloud.gateway.server.webflux.routes[1].filters[2].name=RequestRateLimiter
spring.cloud.gateway.server.webflux.routes[1].filters[2].args.redis-rate-limiter.replenishRate=10
spring.cloud.gateway.server.webflux.routes[1].filters[2].args.redis-rate-limiter.burstCapacity=20
spring.cloud.gateway.server.webflux.routes[1].filters[2].args.key-resolver=#{@userKeyResolver}
spring.cloud.gateway.server.webflux.routes[1].filters[3].name=CircuitBreaker
spring.cloud.gateway.server.webflux.routes[1].filters[3].args.name=orderServiceCB
spring.cloud.gateway.server.webflux.routes[1].filters[3].args.fallbackUri=forward:/fallback

# Admin Service Routes
spring.cloud.gateway.server.webflux.routes[2].id=admin-service
spring.cloud.gateway.server.webflux.routes[2].uri=${ADMIN_SERVICE_URL:http://127.0.0.1:8084}
spring.cloud.gateway.server.webflux.routes[2].predicates[0]=Path=/admin/**
spring.cloud.gateway.server.webflux.routes[2].filters[0]=StripPrefix=1
spring.cloud.gateway.server.webflux.routes[2].filters[1]=PrefixPath=/api
spring.cloud.gateway.server.webflux.routes[2].filters[2].name=RequestRateLimiter
spring.cloud.gateway.server.webflux.routes[2].filters[2].args.redis-rate-limiter.replenishRate=10
spring.cloud.gateway.server.webflux.routes[2].filters[2].args.redis-rate-limiter.burstCapacity=20
spring.cloud.gateway.server.webflux.routes[2].filters[2].args.key-resolver=#{@userKeyResolver}
spring.cloud.gateway.server.webflux.routes[2].filters[3].name=CircuitBreaker
spring.cloud.gateway.server.webflux.routes[2].filters[3].args.name=adminServiceCB
spring.cloud.gateway.server.webflux.routes[2].filters[3].args.fallbackUri=forward:/fallback

# Block external access to internal registration endpoint
# This route has higher priority (order=-1) than the generic admin route
spring.cloud.gateway.server.webflux.routes[3].id=block-internal-registration
spring.cloud.gateway.server.webflux.routes[3].order=-1
spring.cloud.gateway.server.webflux.routes[3].uri=no://op
spring.cloud.gateway.server.webflux.routes[3].predicates[0]=Path=/admin/users/register
spring.cloud.gateway.server.webflux.routes[3].filters[0]=SetStatus=403

# =============================================================================
# Circuit Breaker Configuration (Resilience4j)
# =============================================================================
# Sliding window of 10 calls, opens when 50% fail
resilience4j.circuitbreaker.configs.default.slidingWindowSize=10
resilience4j.circuitbreaker.configs.default.failureRateThreshold=50
resilience4j.circuitbreaker.configs.default.waitDurationInOpenState=10s
resilience4j.circuitbreaker.configs.default.permittedNumberOfCallsInHalfOpenState=3
resilience4j.circuitbreaker.configs.default.automaticTransitionFromOpenToHalfOpenEnabled=true

# Timeout configuration
resilience4j.timelimiter.configs.default.timeoutDuration=5s

# Circuit Breaker Instances (map to default config)
resilience4j.circuitbreaker.instances.profileServiceCB.baseConfig=default
resilience4j.circuitbreaker.instances.orderServiceCB.baseConfig=default
resilience4j.circuitbreaker.instances.adminServiceCB.baseConfig=default

# TimeLimiter Instances (map to default config)
resilience4j.timelimiter.instances.profileServiceCB.baseConfig=default
resilience4j.timelimiter.instances.orderServiceCB.baseConfig=default
resilience4j.timelimiter.instances.adminServiceCB.baseConfig=default

# =============================================================================
# Rate Limiting (Token Bucket Algorithm)
# =============================================================================
# replenishRate: Tokens added per second (sustained rate)
# burstCapacity: Maximum tokens (allows brief spikes)
# With 10/20: 10 req/s sustained, burst to 20
# Returns HTTP 429 when exceeded

# =============================================================================
# Redis Configuration
# =============================================================================
spring.data.redis.host=${REDIS_HOST:localhost}
spring.data.redis.port=${REDIS_PORT:6379}

# =============================================================================
# Security Configuration
# =============================================================================
spring.security.oauth2.resourceserver.jwt.issuer-uri=${KEYCLOAK_ISSUER_URI:http://localhost:8080/realms/my-realm}

# =============================================================================
# Actuator
# =============================================================================
management.endpoints.web.exposure.include=health,info,metrics,prometheus

# =============================================================================
# Distributed Tracing
# =============================================================================
spring.application.name=gateway
management.tracing.sampling.probability=${TRACING_SAMPLING_PROBABILITY:1.0}
management.zipkin.tracing.endpoint=${ZIPKIN_ENDPOINT:http://localhost:9411/api/v2/spans}

# =============================================================================
# OpenAPI Aggregation
# =============================================================================
springdoc.swagger-ui.urls[0].name=Profile Service
springdoc.swagger-ui.urls[0].url=/profile/public/api-docs
springdoc.swagger-ui.urls[1].name=Order Service
springdoc.swagger-ui.urls[1].url=/orders/public/api-docs
